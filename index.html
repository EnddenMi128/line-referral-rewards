<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>æœƒå“¡ä¸­å¿ƒ</title>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body {
  font-family: Arial;
  background:#f7f7f7;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  margin:0;
}

.card {
  background:white;
  padding:24px;
  border-radius:16px;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
  width:90%;
  max-width:420px;
  text-align:center;
}

input,button {
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:8px;
  font-size:14px;
}

button {
  background:#06C755;
  color:white;
  border:none;
  cursor:pointer;
}

.modal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  display:none;
  justify-content:center;
  align-items:center;
}

.modal-box {
  background:white;
  padding:24px;
  border-radius:16px;
  text-align:center;
  width:85%;
  max-width:360px;
}
</style>
</head>

<body>

<div class="card">

<!-- æ–°æœƒå“¡å€ -->
<div id="joinSection" style="display:none;">
<h2>åŠ å…¥æœƒå“¡</h2>
<p>å¡«å¯«å§“åèˆ‡é›»è©±å³å¯é ˜å– LINE æŠ˜åƒ¹åˆ¸</p>
<input id="name" placeholder="å§“å"/>
<input id="phone" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼"/>
<button onclick="submitJoin()">é€å‡ºä¸¦åŠ å…¥</button>
</div>

<!-- èˆŠæœƒå“¡æ¨è–¦å€ -->
<div id="memberSection" style="display:none;">
<h2>æ¨è–¦å¥½å‹æ‹¿çå‹µ</h2>
<p>è®“å¥½å‹æƒæ QR Code å¡«è³‡æ–™ï¼Œä½ èˆ‡å¥½å‹éƒ½å¯ç²å¾— $10 æŠ˜åƒ¹åˆ¸</p>
<img id="qrImg" width="200"/>
<button onclick="copyLink()">è¤‡è£½æ¨è–¦é€£çµ</button>
</div>

</div>

<!-- ç¤¾ç¾¤å½ˆçª— -->
<div id="socialModal" class="modal">
  <div class="modal-box">
    <h3>ğŸ‰ æ­¡è¿åŠ å…¥æœƒå“¡</h3>
    <p>é»ä¸‹æ–¹æŒ‰éˆ•åŠ å…¥å®˜æ–¹ç¤¾ç¾¤<br>æ¥æ”¶æœ€æ–°å„ªæƒ é€šçŸ¥ ğŸ‘‡</p>
    <button onclick="openSocial()">ç«‹å³åŠ å…¥ç¤¾ç¾¤</button>
  </div>
</div>

<script>
const LIFF_ID = "2009103012-Cm3dsFrN";
const GAS_URL = "https://script.google.com/macros/s/AKfycbxlxK-9Ux2rgfOdfN4pWP0MoQd5n76qmsMctP3Esz4Dnc273tg934fqCNZlzrjrhG77SA/exec";

// èˆŠç¾¤å°ˆå±¬é›è›‹å…Œæ›åˆ¸é€£çµ
const SOCIAL_URL = "https://lin.ee/Oo4hXKk";

let currentUserId = "";
let refLink = "";

// åˆå§‹åŒ– LIFF
async function init() {
  await liff.init({ liffId: LIFF_ID });

  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }

  const profile = await liff.getProfile();
  currentUserId = profile.userId;

  checkMember();
}

// æª¢æŸ¥æœƒå“¡
async function checkMember() {
  const res = await fetch(GAS_URL + "?userId=" + currentUserId);
  const data = await res.json();

  if (data.isMember) {
    showMember(data.refUrl);
  } else {
    document.getElementById("joinSection").style.display = "block";
  }
}

// é¡¯ç¤ºèˆŠæœƒå“¡æ¨è–¦å€
function showMember(url) {
  document.getElementById("memberSection").style.display = "block";
  document.getElementById("joinSection").style.display = "none";

  refLink = url;
  document.getElementById("qrImg").src =
    "https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=" +
    encodeURIComponent(url);
}

// æäº¤æ–°æœƒå“¡è³‡æ–™
async function submitJoin() {
  const nm = document.getElementById("name").value.trim();
  const ph = document.getElementById("phone").value.trim();

  if (!nm || !ph) {
    alert("è«‹å¡«å¯«å§“åèˆ‡æ‰‹æ©Ÿè™Ÿç¢¼");
    return;
  }

  const params = new URLSearchParams();
  params.append("userId", currentUserId);
  params.append("name", nm);
  params.append("phone", ph);

  const urlParams = new URLSearchParams(location.search);
  const refUserId = urlParams.get("refUserId");
  const campaign = urlParams.get("campaign"); // åªæœ‰èˆŠç¾¤å°ˆå±¬é€£çµæ‰å¸¶é€™å€‹

  if (refUserId) params.append("refUserId", refUserId);
  if (campaign) params.append("campaign", campaign);

  const res = await fetch(GAS_URL, { method:"POST", body:params });
  const data = await res.json();

  if (data.status === "OK" || data.status === "ALREADY_MEMBER") {
    // éš±è—å¡«è³‡æ–™
    document.getElementById("joinSection").style.display = "none";

    // åªæœ‰èˆŠç¾¤å°ˆå±¬é€£çµæ‰è·³é›è›‹å…Œæ›åˆ¸ç¤¾ç¾¤å½ˆçª—
    if (campaign === "social") {
      showSocialModal();
    }

  } else {
    alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
  }
}

// é¡¯ç¤ºç¤¾ç¾¤å½ˆçª—
function showSocialModal() {
  document.getElementById("socialModal").style.display = "flex";
}

// é–‹å•Ÿ LINE ç¤¾ç¾¤
function openSocial() {
  liff.openWindow({
    url: SOCIAL_URL,
    external: true
  });
}

// è¤‡è£½æ¨è–¦é€£çµ
function copyLink() {
  navigator.clipboard.writeText(refLink);
  alert("æ¨è–¦é€£çµå·²è¤‡è£½");
}

init();
</script>

</body>
</html>
