<script>
  const LIFF_ID = "2009103012-Cm3dsFrN";
  const GAS_URL = "https://script.google.com/macros/s/AKfycbzQ92BIeccYMgAdImmHMCy97oxgSMo72yQg9iOr4z7IrA5enYG1jOWrcLeGESeWO_TwoA/exec";

  // ⭐ 讀網址推薦碼
  const urlParams = new URLSearchParams(location.search);
  const refFromUrl = urlParams.get("ref") || "";

  async function init() {
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
  }
  init();

  async function submitForm() {
    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();

    if (!name || !phone) {
      alert("請填寫姓名與手機");
      return;
    }

    document.getElementById("loadingMsg").style.display = "block";

    try {
      const profile = await liff.getProfile();
      const userId = profile.userId;

      const params = new URLSearchParams();
      params.append("name", name);
      params.append("phone", phone);
      params.append("ref", refFromUrl); // ⭐ 自動帶推薦碼
      params.append("userId", userId);

      await fetch(GAS_URL, {
        method: "POST",
        mode: "no-cors",
        body: params
      });

      document.getElementById("loadingMsg").style.display = "none";
      document.getElementById("successMsg").style.display = "block";

    } catch (err) {
      document.getElementById("loadingMsg").style.display = "none";
      alert("送出失敗，請稍後再試");
      console.error(err);
    }
  }
</script>
